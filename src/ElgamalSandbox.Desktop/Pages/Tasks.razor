@page "/tasks"
@using ElgamalSandbox.Core.Entities
@using ElgamalSandbox.Core.Abstractions
@using Microsoft.EntityFrameworkCore
@inject IDbContext DbContext
@inject NavigationManager NavigationManager

<MudTable T="TaskDescription" RowClass="cursor-pointer" OnRowClick="OnItemSelected" Items="@Elements">
    <HeaderContent>
        <MudTh>Номер</MudTh>
        <MudTh>Название</MudTh>
        <MudTh>Кол-во попыток</MudTh>
        <MudTh>Последняя попытка</MudTh>
        <MudTh>Статус</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Номер">@context.Number</MudTd>
        <MudTd DataLabel="Название">
            @context.Name
        </MudTd>
        <MudTd DataLabel="Кол-во попыток">@context.Attempts.Count</MudTd>
        <MudTd DataLabel="Последняя попытка">
            @(context.Attempts.Any()
                ? $"{context.Attempts.MaxBy(x => x.CreatedAt).CreatedAt.ToLocalTime():dd.MM.yyyy hh:mm}"
                :"")
        </MudTd>
        <MudTd DataLabel="Статус">
            <TaskResultChip TaskDescription="@context"></TaskResultChip>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private IEnumerable<TaskDescription> Elements { get; set; }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        Elements = await DbContext.TaskDescriptions
            .Include(x => x.Attempts)
                .ThenInclude(x => x.Tests)
            .ToListAsync();
    }

    private void OnItemSelected(TableRowClickEventArgs<TaskDescription> tableRowClickEventArgs)
    {
        NavigationManager.NavigateTo($"/task/{tableRowClickEventArgs.Item.Id}");
    }

}
